---
phase: 06-exit-logging
plan: 03
type: execute
wave: 2
depends_on: [06-01, 06-02]
files_modified:
  - src/lib/logger/log-rotator.ts
  - src/cli.ts
  - src/gsdo.ts
autonomous: true

must_haves:
  truths:
    - "Log files rotate daily when first run of new day occurs"
    - "Old logs compressed with gzip before deletion"
    - "Only past 7 days of logs retained"
    - "Current log remains uncompressed and active"
    - "Rotation happens transparently without user intervention"
  artifacts:
    - path: "src/lib/logger/log-rotator.ts"
      provides: "Log rotation logic with daily rotation and 7-day retention"
      exports: ["rotateLogsIfNeeded"]
      min_lines: 100
    - path: "~/.gsdo/install.log"
      provides: "Current active install log"
      contains: "# Installation Log"
    - path: "~/.gsdo/install.1.log.gz"
      provides: "Yesterday's compressed install log (if exists)"
  key_links:
    - from: "src/cli.ts"
      to: "src/lib/logger/log-rotator.ts"
      via: "rotateLogsIfNeeded call before logging"
      pattern: "rotateLogsIfNeeded.*install"
    - from: "src/gsdo.ts"
      to: "src/lib/logger/log-rotator.ts"
      via: "rotateLogsIfNeeded call before logging"
      pattern: "rotateLogsIfNeeded.*gsdo"
    - from: "src/lib/logger/log-rotator.ts"
      to: "node:zlib"
      via: "gzip compression"
      pattern: "createGzip|gzip"
---

<objective>
Implement log rotation with daily rotation, gzip compression, and 7-day retention for both install.log and gsdo.log.

Purpose: Prevent log files from growing unbounded while retaining recent history for troubleshooting. Compressed old logs save disk space. Automatic cleanup maintains manageable storage footprint.

Output: Log rotator module and integration into CLI and /gsdo entry points
</objective>

<execution_context>
@C:\Users\Terence\code\gsd-open\.planning\workflows\execute-plan.md
@C:\Users\Terence\code\gsd-open\.planning\templates\summary.md
</execution_context>

<context>
@C:\Users\Terence\code\gsd-open\.planning\PROJECT.md
@C:\Users\Terence\code\gsd-open\.planning\ROADMAP.md
@C:\Users\Terence\code\gsd-open\.planning\STATE.md
@C:\Users\Terence\code\gsd-open\.planning\REQUIREMENTS.md
@C:\Users\Terence\code\gsd-open\.planning\phases\06-exit-logging\06-CONTEXT.md

# Logger infrastructure created in previous plans
@C:\Users\Terence\code\gsd-open\src\cli.ts
@C:\Users\Terence\code\gsd-open\src\gsdo.ts
@C:\Users\Terence\code\gsd-open\src\lib\paths.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create log rotation module with compression and cleanup</name>
  <files>
    src/lib/logger/log-rotator.ts
  </files>
  <action>
Create log rotator in src/lib/logger/log-rotator.ts:

Export rotateLogsIfNeeded(logFilename: 'install.log' | 'gsdo.log'): Promise<void> function:

Logic:
1. Resolve log path: ~/.gsdo/[logFilename]
2. Check if log file exists, if not return early
3. Read log file stat to get last modified date
4. Get current date
5. If same day (YYYY-MM-DD match), return early (no rotation needed)
6. Rotation needed - perform rotation:
   a. Shift existing rotated logs:
      - install.6.log.gz -> install.7.log.gz (then delete 7)
      - install.5.log.gz -> install.6.log.gz
      - ... down to install.1.log.gz -> install.2.log.gz
   b. Compress current log to install.1.log.gz:
      - Read current log content
      - Use zlib.gzip to compress
      - Write to install.1.log.gz
      - Delete original log file
   c. Delete logs older than 7 days (install.8.log.gz and higher if exist)

Use Node.js built-in modules:
- 'node:fs' for existsSync
- 'node:fs/promises' for readFile, writeFile, rename, unlink, stat
- 'node:zlib' for gzip compression (createGzip or gzip helper)
- 'node:path' for join

Helper function compressLog(sourcePath, destPath): Promise<void>:
- Read source file
- Compress with zlib.gzip (promisified)
- Write to dest file with .gz extension
- Delete source file

Rotation pattern:
- install.log -> install.1.log.gz
- install.1.log.gz -> install.2.log.gz
- install.2.log.gz -> install.3.log.gz
- ...
- install.6.log.gz -> install.7.log.gz (then delete 7 to enforce 7-day limit)

Handle errors gracefully:
- If rotation fails, log warning to console but don't throw
- Current log file should still be writable even if rotation fails

Use resolveHome from lib/paths.ts for ~/.gsdo/ resolution.
  </action>
  <verify>
npm test -- log-rotator.test.ts passes (create test file mocking filesystem operations and testing rotation logic)
  </verify>
  <done>
- src/lib/logger/log-rotator.ts exports rotateLogsIfNeeded function
- Rotation logic shifts logs correctly (N -> N+1)
- Old logs compressed with gzip
- Logs older than 7 days deleted
- Same-day check prevents unnecessary rotation
- Graceful error handling (rotation failures don't crash)
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate log rotation into CLI and /gsdo entry points</name>
  <files>
    src/cli.ts
    src/gsdo.ts
  </files>
  <action>
In src/cli.ts:

Import rotateLogsIfNeeded from './lib/logger/log-rotator.js'.

Add rotation call BEFORE writing install log (around line where writeInstallLog is called):
```
await rotateLogsIfNeeded('install.log').catch(err =>
  console.warn('Log rotation failed:', err)
);
```

In src/gsdo.ts:

Import rotateLogsIfNeeded from './lib/logger/log-rotator.js'.

Add rotation call BEFORE writing enhancement log (in main function, early after context loading):
```
await rotateLogsIfNeeded('gsdo.log').catch(err =>
  console.warn('Log rotation failed:', err)
);
```

Also add rotation for gsdo.log in src/cli.ts inline enhancement section (around line where inline enhancement logs are written).

Use non-blocking pattern - rotation failures shouldn't crash installer/gsdo.

Rotation check is fast (just stat check) when no rotation needed, so minimal performance impact.
  </action>
  <verify>
1. Create mock ~/.gsdo/install.log with old mtime (yesterday)
2. Run npm run dev
3. Check install.1.log.gz created and install.log is fresh
4. Run npm run dev again same day
5. Verify no rotation happened (install.1.log.gz unchanged)
6. Repeat test for gsdo.log with npx gsdo
  </verify>
  <done>
- CLI rotates install.log before writing new entries
- /gsdo rotates gsdo.log before writing new entries
- Rotation only happens on first run of new day
- Old logs compressed and numbered sequentially
- Logs older than 7 days cleaned up
- Rotation failures don't crash installer or /gsdo
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. Create old log file: echo "old log" > ~/.gsdo/install.log && touch -t 202601220000 ~/.gsdo/install.log
2. Run installer: npm run dev
3. Verify:
   - ~/.gsdo/install.1.log.gz exists (compressed old log)
   - ~/.gsdo/install.log exists and is fresh (new log for today)
4. Run installer again same day
5. Verify install.1.log.gz unchanged (no rotation on same day)
6. Repeat test for gsdo.log with npx gsdo
7. Test 7-day retention:
   - Create install.7.log.gz mock file
   - Run installer
   - Verify install.7.log.gz deleted or shifted to 8 then deleted

All checks pass = LOG-05 and LOG-06 requirements satisfied.
</verification>

<success_criteria>
- Log files rotate daily on first run of new day
- Current log (install.log, gsdo.log) remains uncompressed
- Old logs compressed with gzip (install.1.log.gz, etc.)
- Sequential numbering: 1 (yesterday), 2 (2 days ago), ... 7 (7 days ago)
- Logs older than 7 days automatically deleted
- Rotation is transparent (no user intervention required)
- Rotation failures don't crash installer or /gsdo
- Same-day runs skip rotation (performance optimization)
</success_criteria>

<output>
After completion, create `.planning/phases/06-exit-logging/06-03-SUMMARY.md`
</output>
