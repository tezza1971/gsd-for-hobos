---
phase: 06-exit-logging
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/logger/gsdo-logger.ts
  - src/gsdo.ts
  - src/cli.ts
  - src/lib/enhancer/enhancer.ts
autonomous: true

must_haves:
  truths:
    - "/gsdo command writes timestamped log entries to ~/.gsdo/gsdo.log"
    - "Log includes per-command enhancement results with before/after JSON"
    - "Log includes LLM reasoning for each change"
    - "Enhancement improvements validate naming, templates, parameters, references"
    - "Commands.json updated in place with enhanced versions"
  artifacts:
    - path: "src/lib/logger/gsdo-logger.ts"
      provides: "Enhancement log writing with before/after command JSON"
      exports: ["writeEnhancementLog", "EnhancementLogEntry"]
      min_lines: 80
    - path: "~/.gsdo/gsdo.log"
      provides: "Persisted enhancement logs"
      contains: "# Enhancement Log"
    - path: "src/lib/enhancer/enhancer.ts"
      provides: "Enhanced enhancement logic checking naming, templates, params, refs"
      exports: ["enhanceAllCommands"]
  key_links:
    - from: "src/gsdo.ts"
      to: "src/lib/logger/gsdo-logger.ts"
      via: "writeEnhancementLog call after enhancement"
      pattern: "writeEnhancementLog.*results"
    - from: "src/lib/enhancer/enhancer.ts"
      to: "src/lib/logger/gsdo-logger.ts"
      via: "enriched enhancement results with reasoning"
      pattern: "EnhancementResult.*reasoning"
---

<objective>
Create enhancement logging infrastructure and improve enhancement logic to validate naming, templates, parameters, and references.

Purpose: Provide detailed visibility into what enhancements were made, why they were made, and the before/after state of each command. Ensure enhancement logic covers all improvement categories (ENHANCE-05 through ENHANCE-09).

Output: Enhancement logger module, improved enhancement validation, integration into /gsdo workflow
</objective>

<execution_context>
@C:\Users\Terence\code\gsd-open\.planning\workflows\execute-plan.md
@C:\Users\Terence\code\gsd-open\.planning\templates\summary.md
</execution_context>

<context>
@C:\Users\Terence\code\gsd-open\.planning\PROJECT.md
@C:\Users\Terence\code\gsd-open\.planning\ROADMAP.md
@C:\Users\Terence\code\gsd-open\.planning\STATE.md
@C:\Users\Terence\code\gsd-open\.planning\REQUIREMENTS.md
@C:\Users\Terence\code\gsd-open\.planning\phases\06-exit-logging\06-CONTEXT.md

# Enhancement implementation
@C:\Users\Terence\code\gsd-open\src\gsdo.ts
@C:\Users\Terence\code\gsd-open\src\lib\enhancer\enhancer.ts
@C:\Users\Terence\code\gsd-open\src\lib\enhancer\engine.ts
@C:\Users\Terence\code\gsd-open\src\lib\enhancer\types.ts
@C:\Users\Terence\code\gsd-open\src\lib\logger\types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create enhancement logger with before/after JSON and reasoning</name>
  <files>
    src/lib/logger/gsdo-logger.ts
  </files>
  <action>
Create enhancement logger in src/lib/logger/gsdo-logger.ts:

Define EnhancementLogEntry interface:
- timestamp: string
- summary: string (e.g., "Enhanced 5 commands")
- results: Array<{ commandName: string, enhanced: boolean, changes: string[], reasoning: string, before: OpenCodeCommand | null, after: OpenCodeCommand | null, error?: string }>
- metadata: { enhanced: number, unchanged: number, failed: number }

Export writeEnhancementLog(entry: EnhancementLogEntry): Promise<void> function:
- Formats entry as markdown with:
  - H1 header: "# Enhancement Log"
  - H2 per entry: "## [timestamp] - [summary]"
  - Metadata section: "**Summary:** X enhanced, Y unchanged, Z failed"
  - Per-command sections with:
    - H3: "### [commandName]"
    - Status: ✓ Enhanced | ✗ Failed | — Unchanged
    - Changes list if enhanced
    - Reasoning paragraph
    - Before JSON (fenced code block) if available
    - After JSON (fenced code block) if available
    - Error message if failed
  - Horizontal rule separator (---) between entries
- Use fs.appendFile to append entries
- Create ~/.gsdo/ directory if not exists
- Use resolveHome from lib/paths.ts

Follow existing patterns from install-logger.ts:
- Import from 'node:fs/promises', 'node:fs', 'node:path'
- Import resolveHome from '../paths.js'
- Graceful error handling
- Non-blocking (don't throw on write failures)
  </action>
  <verify>
npm test -- gsdo-logger.test.ts passes (create test file testing entry formatting with before/after JSON)
  </verify>
  <done>
- src/lib/logger/gsdo-logger.ts exports writeEnhancementLog and EnhancementLogEntry
- Test coverage validates markdown format with before/after JSON blocks
- Reasoning section included for each command
- Human-readable and machine-parseable format
  </done>
</task>

<task type="auto">
  <name>Task 2: Review and improve enhancement validation logic</name>
  <files>
    src/lib/enhancer/enhancer.ts
    src/lib/enhancer/types.ts
  </files>
  <action>
Review enhancer.ts against requirements ENHANCE-05 through ENHANCE-09:

ENHANCE-05 (Naming issues): LLM prompt already instructs fixing naming - VERIFY present
ENHANCE-06 (Prompt templates): LLM prompt already instructs improving templates - VERIFY present
ENHANCE-07 (Missing parameters): LLM prompt already instructs adding parameters - VERIFY present
ENHANCE-08 (Broken references): LLM prompt already instructs fixing references - VERIFY present
ENHANCE-09 (Update in place): Already implemented via writeCommands - VERIFY present

Review buildEnhancementPrompt function:
- Ensure prompt explicitly asks LLM to check: naming conventions, template quality, parameter completeness, agent/tool reference validity
- Ensure prompt asks for reasoning explanation in response

Update EnhancementResult type in types.ts to include:
- reasoning: string field (LLM's explanation of changes)

Update enhanceCommand function:
- Parse 'reasoning' field from LLM response JSON
- Include reasoning in returned EnhancementResult

Update enhanceAllCommands function:
- Include before/after command snapshots in results
- before: original command JSON
- after: enhanced command JSON (if enhanced)

If enhancement logic already covers all requirements, add comments documenting which requirement each prompt section addresses.

If gaps found (unlikely based on existing code review), extend prompt to cover missing aspects.
  </action>
  <verify>
npm test passes all existing enhancer tests.
Review enhancer.ts confirms all ENHANCE-05 through ENHANCE-09 explicitly covered in LLM prompt.
EnhancementResult includes reasoning field.
  </verify>
  <done>
- Enhancement logic validated against ENHANCE-05 through ENHANCE-09
- LLM prompt explicitly covers naming, templates, parameters, references
- EnhancementResult includes reasoning field
- Before/after command snapshots captured in results
- Code comments document requirement coverage
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate enhancement logging into /gsdo and CLI workflows</name>
  <files>
    src/gsdo.ts
    src/cli.ts
  </files>
  <action>
In src/gsdo.ts:

Import writeEnhancementLog from './lib/logger/gsdo-logger.js'.
Import EnhancementLogEntry type.

After enhancement completes (after line ~85 where summary is logged), create EnhancementLogEntry:
- timestamp: new Date().toISOString()
- summary: `Enhanced ${enhancedCount} of ${results.length} commands`
- results: Map enhancement results to include before/after snapshots and reasoning
- metadata: { enhanced: enhancedCount, unchanged: unchangedCount, failed: failedCount }

Call writeEnhancementLog(logEntry).catch(err => console.warn('Failed to write enhancement log:', err))

In src/cli.ts (inline enhancement section around line ~189-228):

Import writeEnhancementLog from './lib/logger/gsdo-logger.js'.

After inline enhancement completes (after line ~223), create EnhancementLogEntry similar to gsdo.ts and write log.

Use non-blocking pattern - log write failures shouldn't crash installer/gsdo.

Keep existing console.log output unchanged (logging is additive).
  </action>
  <verify>
Run npx gsdo (in mock environment or with test data).
Check ~/.gsdo/gsdo.log exists and contains formatted entries with before/after JSON and reasoning.
Run npm run dev (installer), verify enhancement log also written from inline enhancement.
  </verify>
  <done>
- /gsdo writes enhancement log after each run
- CLI writes enhancement log after inline enhancement
- Log entries contain before/after command JSON
- Log entries contain LLM reasoning for changes
- Failed log writes don't crash /gsdo or installer
- Multiple runs append entries (no overwriting)
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Run /gsdo command: npm run dev (triggers inline enhancement) or npx gsdo
2. Check log file: cat ~/.gsdo/gsdo.log
3. Verify format:
   - Markdown structure with command sections
   - Metadata summary section
   - Per-command before/after JSON blocks
   - Reasoning paragraphs for changes
   - Status indicators (✓ Enhanced, — Unchanged, ✗ Failed)
   - Horizontal rule separator
4. Review enhancer.ts prompt
5. Verify prompt covers: naming fixes, template improvements, parameter additions, reference fixes
6. Run /gsdo again
7. Verify second entry appended

All checks pass = LOG-03, LOG-04, ENHANCE-05 through ENHANCE-09 requirements satisfied.
</verification>

<success_criteria>
- Enhancement log written to ~/.gsdo/gsdo.log after each /gsdo run
- Log uses markdown format with before/after command JSON blocks
- Per-command results include LLM reasoning for changes
- Metadata summary shows counts (X enhanced, Y unchanged, Z failed)
- Enhancement logic covers naming, templates, parameters, references (ENHANCE-05 through ENHANCE-09)
- Entries append (don't overwrite previous entries)
- Log write failures don't crash /gsdo or installer
- Log is human-readable and machine-parseable
</success_criteria>

<output>
After completion, create `.planning/phases/06-exit-logging/06-02-SUMMARY.md`
</output>
