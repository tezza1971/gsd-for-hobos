---
phase: 02-detection
plan: 03
type: execute
wave: 2
depends_on: [02-01, 02-02]
files_modified:
  - src/lib/detection/reporter.ts
  - src/commands/detect.ts
  - src/cli.ts
  - src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "User sees detection report with checkmarks for found/missing installations"
    - "User with incomplete GSD sees specific missing files/directories listed"
    - "User without OpenCode sees actionable error message"
    - "User can be prompted for custom GSD path when not at default location"
    - "User sees installation help when GSD not found"
  artifacts:
    - path: "src/lib/detection/reporter.ts"
      provides: "Format detection results with status symbols"
      exports: ["formatDetectionReport"]
      min_lines: 40
    - path: "src/commands/detect.ts"
      provides: "Detection orchestration and interactive prompts"
      exports: ["detectCommand"]
      min_lines: 80
    - path: "src/cli.ts"
      provides: "Wire detect command into CLI (optional --detect flag)"
      contains: ".option('--detect'"
    - path: "src/types/index.ts"
      provides: "Validation report aggregate type"
      contains: "ValidationReport"
  key_links:
    - from: "src/commands/detect.ts"
      to: "src/lib/detection/gsd-detector.ts"
      via: "imports detectGSD"
      pattern: "import.*detectGSD"
    - from: "src/commands/detect.ts"
      to: "src/lib/detection/opencode-detector.ts"
      via: "imports detectOpenCode"
      pattern: "import.*detectOpenCode"
    - from: "src/commands/detect.ts"
      to: "src/lib/detection/reporter.ts"
      via: "imports formatDetectionReport"
      pattern: "import.*reporter"
    - from: "src/commands/detect.ts"
      to: "@clack/prompts"
      via: "select/text for interactive prompts"
      pattern: "import.*@clack/prompts"
---

<objective>
Orchestrate GSD and OpenCode detection, format visual report, handle interactive prompts for missing installations.

Purpose: Integrate detection modules into user-facing CLI command with actionable feedback.
Output: Complete detection flow from CLI invocation to formatted report output.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-detection/02-CONTEXT.md
@.planning/phases/02-detection/02-RESEARCH.md

# Prior work (must be complete)
@.planning/phases/02-detection/02-01-PLAN.md
@.planning/phases/02-detection/02-02-PLAN.md

# Established codebase
@src/lib/logger.ts
@src/lib/exit-codes.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create detection reporter with visual formatting</name>
  <files>
    src/lib/detection/reporter.ts
    src/types/index.ts
  </files>
  <action>
Create reporter.ts that formats detection results with status symbols and colors.

Implement formatDetectionReport(report: ValidationReport): void function.

Visual format (from CONTEXT.md):
- Use checkmarks/X: ✓ for found/valid, ✗ for missing/invalid
- Color coding: green(✓), red(✗), yellow(⚠) for warnings
- Indent details under each component

Example output:
```
Detection Report:

✓ GSD
  ~/.claude/get-shit-done
  ⚠ Outdated (120 days old) - consider updating

✗ OpenCode
  Not found in PATH
  Install: npm install -g opencode-ai

Ready for transpilation: NO
```

ValidationReport type:
```typescript
type ValidationReport = {
  gsd: GSDDetectionResult;
  opencode: OpenCodeDetectionResult;
  ready: boolean;  // Both found and valid
};
```

Add ValidationReport to types/index.ts.

Use picocolors for colors (already in dependencies):
- pc.green(), pc.red(), pc.yellow(), pc.bold()

Follow RESEARCH.md Pattern 3 (lines 142-185) for report structure.

AVOID:
- Console.log raw JSON (use formatted output)
- Unicode that may not render on all terminals (✓✗⚠ are safe, tested widely)
  </action>
  <verify>
1. Run `npm run build` - compiles without errors
2. Check exports: grep "export.*formatDetectionReport" src/lib/detection/reporter.ts
3. Verify ValidationReport type: grep "ValidationReport" src/types/index.ts
  </verify>
  <done>
reporter.ts exists with formatDetectionReport export, uses picocolors for colors, outputs checkmark/X visual format, ValidationReport type in types/index.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create detect command with orchestration and prompts</name>
  <files>
    src/commands/detect.ts
  </files>
  <action>
Create detect.ts command that orchestrates GSD and OpenCode detection with interactive prompts.

Implement detectCommand(options: CLIOptions): Promise<void> function.

Flow:
1. **Run detections in parallel**
   - const [gsdResult, opencodeResult] = await Promise.all([detectGSD(), detectOpenCode()])

2. **Handle GSD not found at default location**
   - If !gsdResult.found and !options.quiet:
     - Use @clack/prompts select() to offer choices:
       - 'Enter custom path'
       - 'Show installation instructions'
       - 'Cancel'
   - If 'Enter custom path': use text() prompt, then re-run detectGSD with custom path
   - If 'Show installation instructions': log.info with git clone command and GSD repo URL

3. **Build ValidationReport**
   - Aggregate gsdResult and opencodeResult
   - Set ready: gsdResult.found && gsdResult.valid && opencodeResult.found

4. **Format and display report**
   - Call formatDetectionReport(report)

5. **Set exit code**
   - If ready: EXIT_CODE.SUCCESS
   - If warnings (stale GSD but otherwise ready): EXIT_CODE.WARNING
   - If not ready: EXIT_CODE.ERROR

Handle quiet mode: Skip interactive prompts, just run detection and report.

Follow RESEARCH.md Pattern 2 (lines 104-140) for graceful degradation with prompts.

AVOID:
- Running detections sequentially (use Promise.all)
- Prompting in quiet mode (respect flag)
- Blocking on missing installations (report and continue)
  </action>
  <verify>
1. Run `npm run build` - compiles without errors
2. Check exports: grep "export.*detectCommand" src/commands/detect.ts
3. Verify parallel detection: grep "Promise\\.all" src/commands/detect.ts
4. Check clack import: grep "@clack/prompts" src/commands/detect.ts
  </verify>
  <done>
detect.ts exists with detectCommand export, runs GSD and OpenCode detection in parallel, handles interactive prompts for missing GSD, formats and displays report, sets appropriate exit codes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire detect command into CLI</name>
  <files>
    src/cli.ts
  </files>
  <action>
Update cli.ts to make detection the default action when no subcommand specified.

Changes:
1. Import detectCommand from commands/detect.ts
2. Update main .action() handler to call detectCommand(options)
3. Keep existing flag handling (--help, --version, manifesto) unchanged

Detection now runs by default when user runs: `npx gsd-for-hobos` (no args beyond flags).

Future phases will add explicit subcommands (transpile, report, etc.). For now, detection is the sole functionality after manifesto.

Follow existing pattern from manifesto.ts integration (lines in cli.ts where showManifesto is called).

AVOID:
- Breaking existing --help, --version, manifesto flow
- Adding premature subcommand structure (keep simple for Phase 2)
  </action>
  <verify>
1. Run `npm run build` - compiles without errors
2. Check import: grep "import.*detect" src/cli.ts
3. Run CLI: npm run start (should show manifesto then detection report)
  </verify>
  <done>
cli.ts calls detectCommand as default action, manifesto still shows first, detection runs after acceptance, --help and --version still bypass manifesto.
  </done>
</task>

</tasks>

<verification>
After task completion:
1. Build succeeds: `npm run build`
2. CLI runs detection: `npm run start` shows manifesto → detection report
3. Interactive prompts work: Declining manifesto exits gracefully, missing GSD prompts for path
4. Exit codes correct: SUCCESS when ready, WARNING for stale, ERROR for missing installations
5. Visual report renders: Checkmarks and colors display correctly in terminal
</verification>

<success_criteria>
- User sees formatted detection report with ✓/✗ symbols and colors
- User with GSD at default location sees auto-detection (no prompts)
- User without GSD gets prompted for custom path or installation help
- User with incomplete GSD sees specific missing files/dirs listed
- User without OpenCode sees clear "not found" message with install command
- Detection respects --quiet flag (no interactive prompts, just report)
- Exit codes reflect detection status (0=ready, 1=warnings, 2=errors)
</success_criteria>

<output>
After completion, create `.planning/phases/02-detection/02-03-SUMMARY.md`
</output>
