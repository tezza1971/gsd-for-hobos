---
phase: 02-detection
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/detection/opencode-detector.ts
  - src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "CLI can detect OpenCode command in system PATH"
    - "CLI handles Windows executable extensions (.exe, .bat, .cmd)"
    - "CLI reports when OpenCode is not found on system"
  artifacts:
    - path: "src/lib/detection/opencode-detector.ts"
      provides: "OpenCode PATH detection with cross-platform support"
      exports: ["detectOpenCode", "findCommandInPath"]
      min_lines: 60
    - path: "src/types/index.ts"
      provides: "OpenCode detection result type"
      contains: "OpenCodeDetectionResult"
  key_links:
    - from: "src/lib/detection/opencode-detector.ts"
      to: "node:path"
      via: "path.delimiter for cross-platform PATH parsing"
      pattern: "path\\.delimiter"
    - from: "src/lib/detection/opencode-detector.ts"
      to: "node:fs"
      via: "existsSync for file existence checks"
      pattern: "existsSync"
---

<objective>
Build OpenCode detection module that finds opencode command in system PATH with cross-platform support.

Purpose: Validate target platform availability before attempting transpilation.
Output: Reusable detection module handling Windows/Unix PATH differences.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-detection/02-CONTEXT.md
@.planning/phases/02-detection/02-RESEARCH.md

# Prior phase context
@.planning/phases/01-foundation/01-01-SUMMARY.md

# Established codebase
@src/lib/logger.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OpenCode PATH detector</name>
  <files>
    src/lib/detection/opencode-detector.ts
  </files>
  <action>
Create opencode-detector.ts module that searches system PATH for opencode command with cross-platform support.

Implement two functions:

1. **findCommandInPath(cmd: string): string | null**
   - Split process.env.PATH by path.delimiter (: on Unix, ; on Windows)
   - Determine extensions: Windows uses PATHEXT env var (default ['.exe', '.bat', '.cmd']), Unix uses ['']
   - Loop through each PATH directory
   - For each directory, check cmd + each extension
   - Use fs.existsSync(path.join(dir, cmd + ext))
   - Return full path on first match, null if not found
   - Handle missing PATH env gracefully (return null)

2. **detectOpenCode(): OpenCodeDetectionResult**
   - Call findCommandInPath('opencode')
   - If found: return { found: true, path: fullPath }
   - If not found: return { found: false, reason: 'opencode not found in PATH' }

Return type OpenCodeDetectionResult:
```typescript
type OpenCodeDetectionResult = {
  found: boolean;
  path?: string;
  reason?: string;
};
```

Follow RESEARCH.md Pattern 1 for PATH resolution (lines 217-242) and command detection examples (lines 443-476).

Handle edge cases:
- PATH not set: return null immediately
- Empty PATH: return null
- Symlinks: existsSync follows them (correct behavior)
- Case sensitivity: preserve as-is (Unix case-sensitive, Windows case-insensitive filesystem handles it)

AVOID:
- Spawning shell processes (where/which) - use filesystem checks
- Assuming extensions (always check PATHEXT on Windows)
- Throwing exceptions (return null for not found)
  </action>
  <verify>
1. Run `npm run build` - compiles without errors
2. Check exports: grep "export.*detectOpenCode\|findCommandInPath" src/lib/detection/opencode-detector.ts
3. Verify cross-platform logic: grep "path\\.delimiter\|PATHEXT" src/lib/detection/opencode-detector.ts
  </verify>
  <done>
opencode-detector.ts exists with detectOpenCode and findCommandInPath exports, handles Windows PATHEXT extensions, returns null for not found (no exceptions).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add OpenCode detection types</name>
  <files>
    src/types/index.ts
  </files>
  <action>
Update types/index.ts to export OpenCodeDetectionResult type.

Add:
```typescript
export type OpenCodeDetectionResult = {
  found: boolean;
  path?: string;
  reason?: string;
};
```

Place after existing CLIOptions type. Maintain alphabetical order of exports if established.
  </action>
  <verify>
1. Run `npm run build` - compiles without errors
2. Check type export: grep "OpenCodeDetectionResult" src/types/index.ts
  </verify>
  <done>
OpenCodeDetectionResult type exported from types/index.ts, available for import by other modules.
  </done>
</task>

</tasks>

<verification>
After task completion:
1. Module compiles: `npm run build` succeeds
2. Exports present: opencode-detector.ts exports detectOpenCode and findCommandInPath
3. Type safety: OpenCodeDetectionResult in types/index.ts
4. Cross-platform: Uses path.delimiter and PATHEXT
</verification>

<success_criteria>
- OpenCode detection searches PATH using filesystem checks (no shell spawn)
- Handles Windows executable extensions (.exe, .bat, .cmd) via PATHEXT
- Handles Unix no-extension executables
- Returns null/not-found result when OpenCode missing (no exceptions)
- Works across Windows, macOS, Linux
</success_criteria>

<output>
After completion, create `.planning/phases/02-detection/02-02-SUMMARY.md`
</output>
