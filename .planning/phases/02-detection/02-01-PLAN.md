---
phase: 02-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/detection/gsd-detector.ts
  - src/lib/detection/freshness.ts
  - src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "CLI can detect GSD at ~/.claude/ without user interaction"
    - "CLI validates GSD has required files (package.json, commands/, agents/)"
    - "CLI checks GSD freshness using git history or file dates"
    - "CLI reports missing GSD files when installation is incomplete"
  artifacts:
    - path: "src/lib/detection/gsd-detector.ts"
      provides: "GSD path detection and structure validation"
      exports: ["detectGSD", "validateGSDStructure"]
      min_lines: 80
    - path: "src/lib/detection/freshness.ts"
      provides: "Installation freshness checking (git + file dates)"
      exports: ["checkFreshness", "FreshnessStatus"]
      min_lines: 60
    - path: "src/types/index.ts"
      provides: "Detection result types"
      contains: "GSDDetectionResult"
  key_links:
    - from: "src/lib/detection/gsd-detector.ts"
      to: "src/lib/paths.ts"
      via: "imports gsdDir() for default path"
      pattern: "import.*paths"
    - from: "src/lib/detection/freshness.ts"
      to: "node:child_process"
      via: "spawnSync for git commands"
      pattern: "spawnSync.*git"
    - from: "src/lib/detection/gsd-detector.ts"
      to: "src/lib/detection/freshness.ts"
      via: "imports checkFreshness"
      pattern: "import.*freshness"
---

<objective>
Build GSD detection module that auto-detects ~/.claude/, validates installation completeness, and checks freshness.

Purpose: Enable frictionless GSD discovery without user configuration for the 90% case where GSD is at default location.
Output: Reusable detection module with structure validation and freshness checking.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-detection/02-CONTEXT.md
@.planning/phases/02-detection/02-RESEARCH.md

# Prior phase context
@.planning/phases/01-foundation/01-01-SUMMARY.md

# Established codebase
@src/lib/paths.ts
@src/lib/logger.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create freshness checker module</name>
  <files>
    src/lib/detection/freshness.ts
  </files>
  <action>
Create freshness.ts module that checks installation age using git history (preferred) with fallback to file modification dates.

Implement two functions:
1. **checkFreshness(installPath: string): Promise<FreshnessResult>**
   - Check if .git directory exists at installPath
   - If yes: use spawnSync to run `git log -1 --format=%aI` with 5 second timeout
   - Parse ISO date from stdout, calculate days ago
   - If git fails or not a repo: fall back to stat(package.json).mtime
   - Return FreshnessResult with status ('fresh' | 'stale' | 'unknown'), date, daysAgo

2. **isGitRepository(dirPath: string): boolean**
   - Synchronously check if .git directory exists
   - Use fs.existsSync (acceptable here - quick metadata check)

Use 90-day threshold for stale detection (from research recommendations).

Error handling: All git errors return fallback, never throw. Timeouts return fallback.

Follow RESEARCH.md examples for spawnSync usage (lines 480-510) and freshness checking (lines 567-607).

AVOID:
- execSync (use spawnSync for better error handling)
- Throwing exceptions (return fallback results)
- Assuming git exists (always check first)
</action>
  <verify>
1. Run `npm run build` - compiles without errors
2. Check exports: grep "export.*checkFreshness" src/lib/detection/freshness.ts
3. Verify timeout logic present: grep "timeout.*5000" src/lib/detection/freshness.ts
  </verify>
  <done>
freshness.ts exists with checkFreshness and isGitRepository exports, uses spawnSync with timeout, has git + file date fallback logic.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GSD detector module with validation</name>
  <files>
    src/lib/detection/gsd-detector.ts
    src/types/index.ts
  </files>
  <action>
Create gsd-detector.ts module that implements three-phase detection (existence → validation → freshness).

**Phase 1 - Path Detection:**
- detectGSD(): Start with paths.gsdDir() (from existing paths.ts)
- Check if default path exists using fs.promises.access
- Return early if not found (don't throw - return detection result)

**Phase 2 - Structure Validation:**
- validateGSDStructure(gsdPath: string): Check required files/dirs
- Required files: ['package.json', 'README.md']
- Required dirs: ['commands', 'agents']
- Use fs.promises.stat to check each path exists AND is correct type (file vs dir)
- Return { valid: boolean, missingFiles: string[], missingDirs: string[] }

**Phase 3 - Freshness Check:**
- Import checkFreshness from freshness.ts
- Call for valid installations
- Include in final result

Return type GSDDetectionResult:
```typescript
type GSDDetectionResult = {
  found: boolean;
  path?: string;
  valid?: boolean;
  fresh?: boolean;
  daysOld?: number;
  missingFiles?: string[];
  missingDirs?: string[];
  reason?: string;
};
```

Add GSDDetectionResult to src/types/index.ts exports.

Follow RESEARCH.md Pattern 1 (lines 71-102) for three-phase structure and validation examples (lines 514-563).

AVOID:
- Hardcoded paths (use paths.gsdDir())
- Blocking fs calls without error handling
- Assuming directories are writable (just check existence)
  </action>
  <verify>
1. Run `npm run build` - compiles without errors
2. Check exports: grep "export.*detectGSD\|validateGSDStructure" src/lib/detection/gsd-detector.ts
3. Verify type export: grep "GSDDetectionResult" src/types/index.ts
4. Check imports freshness: grep "import.*freshness" src/lib/detection/gsd-detector.ts
  </verify>
  <done>
gsd-detector.ts exists with detectGSD and validateGSDStructure exports, validates package.json + README.md + commands/ + agents/, integrates freshness checking, GSDDetectionResult type exported from types/index.ts.
  </done>
</task>

</tasks>

<verification>
After task completion:
1. Module compiles: `npm run build` succeeds
2. Exports present: freshness.ts exports checkFreshness, gsd-detector.ts exports detectGSD
3. Type safety: GSDDetectionResult in types/index.ts
4. Dependencies wired: gsd-detector imports paths.ts and freshness.ts
</verification>

<success_criteria>
- GSD detection module detects ~/.claude/ without user prompts
- Module validates required files (package.json, README.md) and dirs (commands/, agents/)
- Freshness checking uses git log with file date fallback
- All detection errors return structured results (no exceptions thrown)
- 90-day threshold determines stale status
</success_criteria>

<output>
After completion, create `.planning/phases/02-detection/02-01-SUMMARY.md`
</output>
